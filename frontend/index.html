<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Parental Control Panel - Real Battery Monitoring</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: Arial, sans-serif; background: #f5f5f5; padding: 20px; }
        .container { max-width: 1000px; margin: 0 auto; background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        
        .dashboard-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 2px solid #e9ecef; }
        .child-item { border: 1px solid #e9ecef; padding: 20px; margin: 15px 0; border-radius: 10px; background: #fafafa; transition: all 0.3s ease; }
        .child-item:hover { box-shadow: 0 4px 15px rgba(0,0,0,0.1); transform: translateY(-2px); }
        
        .btn { padding: 10px 20px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; transition: all 0.3s ease; }
        .btn-control { background: linear-gradient(135deg, #007bff, #0056b3); color: white; }
        .btn-refresh { background: linear-gradient(135deg, #28a745, #1e7e34); color: white; }
        .btn-battery { background: linear-gradient(135deg, #ffc107, #e0a800); color: black; }
        .btn-simulate { background: linear-gradient(135deg, #6f42c1, #5a2d9c); color: white; }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.2); }
        
        .battery-container { margin: 15px 0; }
        .battery-level { 
            width: 100%; 
            height: 25px; 
            background: #f8f9fa; 
            border-radius: 12px; 
            overflow: hidden; 
            position: relative;
            border: 2px solid #dee2e6;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
        }
        .battery-fill { 
            height: 100%; 
            border-radius: 10px; 
            transition: all 0.5s ease;
            position: relative;
        }
        .battery-fill::after {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            bottom: 0;
            width: 5px;
            background: rgba(255,255,255,0.3);
            border-radius: 0 10px 10px 0;
        }
        .battery-high { background: linear-gradient(90deg, #28a745, #34ce57, #28a745); }
        .battery-medium { background: linear-gradient(90deg, #ffc107, #ffd54f, #ffc107); }
        .battery-low { background: linear-gradient(90deg, #dc3545, #e74c3c, #dc3545); }
        .battery-charging { 
            background: linear-gradient(90deg, #17a2b8, #20c997, #17a2b8);
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.8; }
            100% { opacity: 1; }
        }
        
        .battery-info { 
            display: flex; 
            justify-content: space-between; 
            margin-top: 8px; 
            font-size: 14px; 
            color: #495057;
            font-weight: bold;
        }
        
        .device-details { display: flex; justify-content: space-between; align-items: flex-start; }
        .device-info { flex: 1; }
        .device-actions { display: flex; flex-direction: column; gap: 10px; min-width: 150px; }
        
        .status-indicator { 
            padding: 6px 12px; 
            border-radius: 20px; 
            font-size: 12px; 
            font-weight: bold;
            display: inline-block;
            margin: 5px 0;
        }
        .status-online { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .status-offline { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .status-charging { 
            background: #d1ecf1; 
            color: #0c5460; 
            border: 1px solid #bee5eb;
            animation: blink 1.5s infinite;
        }
        
        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        
        .device-stats { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); 
            gap: 10px; 
            margin: 15px 0;
            background: white;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #e9ecef;
        }
        
        .stat-item { text-align: center; padding: 10px; }
        .stat-value { font-size: 24px; font-weight: bold; color: #007bff; }
        .stat-label { font-size: 12px; color: #6c757d; margin-top: 5px; }
        
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 8px;
            color: white;
            font-weight: bold;
            z-index: 1000;
            animation: slideIn 0.5s ease;
        }
        
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        .notification.success { background: linear-gradient(135deg, #28a745, #20c997); }
        .notification.warning { background: linear-gradient(135deg, #ffc107, #fd7e14); }
        .notification.error { background: linear-gradient(135deg, #dc3545, #e83e8c); }
        
        .device-header { 
            display: flex; 
            align-items: center; 
            gap: 10px; 
            margin-bottom: 10px;
        }
        
        .device-icon { 
            font-size: 24px; 
            background: #007bff; 
            color: white; 
            padding: 8px; 
            border-radius: 8px;
        }

        .loading { 
            text-align: center; 
            padding: 40px; 
            color: #6c757d;
        }
        
        .no-data {
            text-align: center;
            padding: 40px;
            color: #6c757d;
            background: #f8f9fa;
            border-radius: 10px;
            margin: 20px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="dashboard-header">
            <div>
                <h1>üîã Parental Control - Real Battery Monitor</h1>
                <p style="color: #6c757d; margin-top: 5px;">Live battery data from connected devices</p>
            </div>
            <div style="display: flex; gap: 10px;">
                <button class="btn btn-refresh" onclick="loadRealBatteryData()">üîÑ Refresh</button>
                <button class="btn btn-battery" onclick="loadAllDevices()">üì± Load Devices</button>
                <button class="btn btn-control" onclick="showApiInfo()">‚ÑπÔ∏è API Info</button>
            </div>
        </div>

        <div style="background: linear-gradient(135deg, #e3f2fd, #bbdefb); padding: 15px; border-radius: 10px; margin: 20px 0; border-left: 4px solid #2196f3;">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <div>
                    <strong>üì° Real Battery API Connected</strong>
                    <div style="font-size: 12px; color: #1565c0;">https://sukh-hacker-x4ry.onrender.com/battery</div>
                </div>
                <div style="text-align: right;">
                    <div style="font-size: 12px; color: #1565c0;" id="lastUpdate">Last update: Loading...</div>
                    <div style="font-size: 12px; color: #1565c0;" id="dataStatus">Fetching real battery data...</div>
                </div>
            </div>
        </div>

        <!-- Real Battery Statistics -->
        <div class="device-stats" id="batteryStats">
            <div class="stat-item">
                <div class="stat-value" id="totalDevices">0</div>
                <div class="stat-label">Total Devices</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="avgBattery">0%</div>
                <div class="stat-label">Avg Battery</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="chargingCount">0</div>
                <div class="stat-label">Charging</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="lowBatteryCount">0</div>
                <div class="stat-label">Low Battery</div>
            </div>
        </div>

        <div class="dashboard">
            <h3 style="color: #495057; margin-bottom: 20px;">üì± Connected Devices - Real Battery Data</h3>
            <div id="batteryDataList">
                <div class="loading">
                    <div style="font-size: 48px; margin-bottom: 10px;">üîã</div>
                    <h4>Loading real battery data...</h4>
                    <p>Fetching from https://sukh-hacker-x4ry.onrender.com/battery</p>
                </div>
            </div>
        </div>

        <div style="margin-top: 30px; padding: 20px; background: linear-gradient(135deg, #f8f9fa, #e9ecef); border-radius: 10px;">
            <h4>üîß Device Management</h4>
            <div style="display: flex; gap: 10px; margin-top: 15px; flex-wrap: wrap;">
                <button class="btn btn-control" onclick="loadRealBatteryData()">üîã Refresh Battery Data</button>
                <button class="btn btn-control" onclick="loadAllDevices()">üìä Load All Devices</button>
                <button class="btn btn-control" onclick="testBatteryAPI()">üß™ Test Battery API</button>
                <button class="btn btn-control" onclick="exportBatteryReport()">üìà Export Report</button>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = "https://sukh-hacker-x4ry.onrender.com";
        let batteryData = [];
        let allDevices = [];

        // Show notification
        function showNotification(message, type = 'success') {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                document.body.removeChild(notification);
            }, 3000);
        }

        // Load real battery data from API
        async function loadRealBatteryData() {
            try {
                document.getElementById('batteryDataList').innerHTML = `
                    <div class="loading">
                        <div style="font-size: 48px; margin-bottom: 10px;">‚è≥</div>
                        <h4>Fetching real battery data...</h4>
                        <p>Connecting to battery API</p>
                    </div>
                `;

                const response = await fetch(`${API_BASE}/battery`);
                const data = await response.json();
                
                if (data.battery_data && data.battery_data.length > 0) {
                    batteryData = data.battery_data;
                    renderBatteryData();
                    updateBatteryStatistics();
                    showNotification(`‚úÖ Loaded ${batteryData.length} devices with battery data`, 'success');
                } else {
                    document.getElementById('batteryDataList').innerHTML = `
                        <div class="no-data">
                            <div style="font-size: 64px; margin-bottom: 20px;">üîã</div>
                            <h4>No Battery Data Available</h4>
                            <p>No devices are currently sending battery data to the server.</p>
                            <button class="btn btn-control" onclick="loadAllDevices()" style="margin-top: 20px;">
                                üì± Check Registered Devices
                            </button>
                        </div>
                    `;
                    showNotification('‚ö†Ô∏è No battery data found from devices', 'warning');
                }
                
                document.getElementById('lastUpdate').textContent = `Last update: ${new Date().toLocaleTimeString()}`;
                document.getElementById('dataStatus').textContent = `Real data: ${batteryData.length} devices`;
                
            } catch (error) {
                console.error('Error loading battery data:', error);
                document.getElementById('batteryDataList').innerHTML = `
                    <div class="no-data">
                        <div style="font-size: 64px; margin-bottom: 20px;">‚ùå</div>
                        <h4>Error Loading Battery Data</h4>
                        <p>${error.message}</p>
                        <button class="btn btn-control" onclick="loadRealBatteryData()" style="margin-top: 20px;">
                            üîÑ Retry
                        </button>
                    </div>
                `;
                showNotification(`‚ùå Error: ${error.message}`, 'error');
            }
        }

        // Load all registered devices
        async function loadAllDevices() {
            try {
                const response = await fetch(`${API_BASE}/debug/children`);
                const data = await response.json();
                
                allDevices = data.children || [];
                renderAllDevices();
                showNotification(`üì± Loaded ${allDevices.length} registered devices`, 'success');
                
            } catch (error) {
                showNotification(`‚ùå Error loading devices: ${error.message}`, 'error');
            }
        }

        // Render battery data
        function renderBatteryData() {
            const batteryDataList = document.getElementById('batteryDataList');
            
            batteryDataList.innerHTML = batteryData.map(device => `
                <div class="child-item">
                    <div class="device-details">
                        <div class="device-info">
                            <div class="device-header">
                                <div class="device-icon">${getDeviceIcon(device.device_name)}</div>
                                <div>
                                    <h4 style="margin: 0; color: #343a40;">${device.device_name}</h4>
                                    <div style="font-size: 12px; color: #6c757d;">
                                        ID: ${device.device_id} ‚Ä¢ Last: ${formatTime(device.last_updated)}
                                    </div>
                                </div>
                            </div>
                            
                            <div class="battery-container">
                                <div class="battery-info">
                                    <span>${getBatteryIcon(device.battery_level, device.is_charging)} Battery Level</span>
                                    <span>
                                        <strong>${device.battery_level}%</strong>
                                        ${device.is_charging ? '‚ö° Charging' : ''}
                                    </span>
                                </div>
                                <div class="battery-level">
                                    <div class="battery-fill ${getBatteryClass(device.battery_level, device.is_charging)}" 
                                         style="width: ${device.battery_level}%"></div>
                                </div>
                                <div class="battery-info">
                                    <span>Health: ${device.battery_health || 'N/A'}% ‚Ä¢ Temp: ${device.temperature || 'N/A'}¬∞C</span>
                                    <span class="status-indicator ${device.is_charging ? 'status-charging' : 'status-online'}">
                                        ${device.is_charging ? '‚ö° Charging' : '‚úÖ Online'}
                                    </span>
                                </div>
                            </div>
                            
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 10px; margin-top: 15px;">
                                <div style="text-align: center; padding: 8px; background: #f8f9fa; border-radius: 6px;">
                                    <div style="font-size: 12px; color: #6c757d;">Health</div>
                                    <div style="font-weight: bold; color: #28a745;">${device.battery_health || 'N/A'}%</div>
                                </div>
                                <div style="text-align: center; padding: 8px; background: #f8f9fa; border-radius: 6px;">
                                    <div style="font-size: 12px; color: #6c757d;">Temp</div>
                                    <div style="font-weight: bold; color: #fd7e14;">${device.temperature || 'N/A'}¬∞C</div>
                                </div>
                                <div style="text-align: center; padding: 8px; background: #f8f9fa; border-radius: 6px;">
                                    <div style="font-size: 12px; color: #6c757d;">Voltage</div>
                                    <div style="font-weight: bold; color: #6f42c1;">${device.voltage || 'N/A'}V</div>
                                </div>
                                <div style="text-align: center; padding: 8px; background: #f8f9fa; border-radius: 6px;">
                                    <div style="font-size: 12px; color: #6c757d;">Last Update</div>
                                    <div style="font-weight: bold; color: #17a2b8;">${formatTime(device.last_updated)}</div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="device-actions">
                            <button class="btn btn-control" onclick="viewDeviceStatus('${device.device_id}')">
                                üìä Status
                            </button>
                            <button class="btn btn-battery" onclick="getBatteryHistory('${device.device_id}')">
                                üìà History
                            </button>
                            <button class="btn" style="background: #17a2b8; color: white;" onclick="refreshDeviceBattery('${device.device_id}')">
                                üîÑ Refresh
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // Render all registered devices
        function renderAllDevices() {
            const batteryDataList = document.getElementById('batteryDataList');
            
            if (allDevices.length === 0) {
                batteryDataList.innerHTML = `
                    <div class="no-data">
                        <div style="font-size: 64px; margin-bottom: 20px;">üì±</div>
                        <h4>No Registered Devices</h4>
                        <p>No devices are currently registered in the system.</p>
                    </div>
                `;
                return;
            }
            
            batteryDataList.innerHTML = `
                <div style="margin-bottom: 20px;">
                    <h4>üìã All Registered Devices (${allDevices.length})</h4>
                    <p style="color: #6c757d; font-size: 14px;">These devices are registered but may not be sending battery data yet.</p>
                </div>
                ${allDevices.map(device => `
                    <div class="child-item">
                        <div class="device-details">
                            <div class="device-info">
                                <div class="device-header">
                                    <div class="device-icon">${getDeviceIcon(device.name)}</div>
                                    <div>
                                        <h4 style="margin: 0; color: #343a40;">${device.name}</h4>
                                        <div style="font-size: 12px; color: #6c757d;">
                                            ID: ${device.device_id} ‚Ä¢ Model: ${device.device_model}
                                        </div>
                                    </div>
                                </div>
                                <div style="margin-top: 10px;">
                                    <span class="status-indicator ${device.is_blocked ? 'status-offline' : 'status-online'}">
                                        ${device.is_blocked ? 'üö´ Blocked' : '‚úÖ Active'}
                                    </span>
                                    <span style="font-size: 12px; color: #6c757d; margin-left: 10px;">
                                        Registered: ${formatTime(device.created_at)}
                                    </span>
                                </div>
                            </div>
                            <div class="device-actions">
                                <button class="btn btn-control" onclick="checkDeviceBattery('${device.device_id}')">
                                    üîã Check Battery
                                </button>
                                <button class="btn" style="background: #6c757d; color: white;" onclick="viewDeviceStatus('${device.device_id}')">
                                    ‚ÑπÔ∏è Info
                                </button>
                            </div>
                        </div>
                    </div>
                `).join('')}
            `;
        }

        // Update battery statistics
        function updateBatteryStatistics() {
            const totalDevices = batteryData.length;
            const avgBattery = totalDevices > 0 
                ? Math.round(batteryData.reduce((sum, device) => sum + device.battery_level, 0) / totalDevices)
                : 0;
            const chargingCount = batteryData.filter(device => device.is_charging).length;
            const lowBatteryCount = batteryData.filter(device => device.battery_level <= 20).length;
            
            document.getElementById('totalDevices').textContent = totalDevices;
            document.getElementById('avgBattery').textContent = avgBattery + '%';
            document.getElementById('chargingCount').textContent = chargingCount;
            document.getElementById('lowBatteryCount').textContent = lowBatteryCount;
        }

        // Helper functions
        function getBatteryClass(level, isCharging) {
            if (isCharging) return 'battery-charging';
            if (level > 70) return 'battery-high';
            if (level > 30) return 'battery-medium';
            return 'battery-low';
        }

        function getBatteryIcon(level, isCharging) {
            if (isCharging) return 'üîå';
            if (level > 80) return 'üîã';
            if (level > 50) return 'üîã';
            if (level > 20) return 'ü™´';
            return 'ü™´';
        }

        function getDeviceIcon(deviceName) {
            const name = deviceName.toLowerCase();
            if (name.includes('iphone') || name.includes('ios')) return 'üì±';
            if (name.includes('samsung')) return 'üì±';
            if (name.includes('android')) return 'üì±';
            if (name.includes('ipad') || name.includes('tablet')) return 'üíª';
            return 'üì±';
        }

        function formatTime(timestamp) {
            const date = new Date(timestamp);
            return date.toLocaleTimeString();
        }

        // Device actions
        async function viewDeviceStatus(deviceId) {
            try {
                const response = await fetch(`${API_BASE}/child/status/${deviceId}`);
                const status = await response.json();
                
                alert(`üì± DEVICE STATUS\n\nName: ${status.name}\nBlocked: ${status.is_blocked ? 'Yes' : 'No'}\nChild ID: ${status.child_id}`);
            } catch (error) {
                alert('Error getting device status: ' + error.message);
            }
        }

        async function checkDeviceBattery(deviceId) {
            try {
                const response = await fetch(`${API_BASE}/battery/${deviceId}`);
                const battery = await response.json();
                
                if (battery.status === 'success') {
                    alert(`üîã BATTERY STATUS\n\nDevice: ${battery.device_name}\nBattery: ${battery.battery_level}%\nCharging: ${battery.is_charging ? 'Yes' : 'No'}\nHealth: ${battery.battery_health}%\nTemperature: ${battery.temperature}¬∞C\nVoltage: ${battery.voltage}V\nLast Update: ${formatTime(battery.last_updated)}`);
                } else {
                    alert('No battery data available for this device');
                }
            } catch (error) {
                alert('Error checking battery: ' + error.message);
            }
        }

        async function getBatteryHistory(deviceId) {
            try {
                const response = await fetch(`${API_BASE}/battery/history/${deviceId}`);
                const history = await response.json();
                
                if (history.history && history.history.length > 0) {
                    const historyText = history.history.map(entry => 
                        `${formatTime(entry.timestamp)} - ${entry.battery_level}% ${entry.is_charging ? '‚ö°' : ''}`
                    ).join('\n');
                    
                    alert(`üìà BATTERY HISTORY\n\nDevice: ${deviceId}\n\n${historyText}`);
                } else {
                    alert('No battery history available for this device');
                }
            } catch (error) {
                alert('Error getting battery history: ' + error.message);
            }
        }

        async function refreshDeviceBattery(deviceId) {
            try {
                const response = await fetch(`${API_BASE}/battery/${deviceId}`);
                const battery = await response.json();
                
                if (battery.status === 'success') {
                    showNotification(`üîã ${battery.device_name} battery: ${battery.battery_level}%`, 'success');
                    // Reload all battery data
                    loadRealBatteryData();
                }
            } catch (error) {
                showNotification('Error refreshing battery data', 'error');
            }
        }

        async function testBatteryAPI() {
            try {
                const response = await fetch(`${API_BASE}/battery/stats`);
                const stats = await response.json();
                
                alert(`üß™ BATTERY API TEST\n\nStatus: ‚úÖ WORKING\nTotal Devices: ${stats.stats.total_devices}\nAverage Battery: ${stats.stats.average_battery}%\nCharging: ${stats.stats.charging_count}\nLow Battery: ${stats.stats.low_battery_count}\nLast Updated: ${formatTime(stats.stats.last_updated)}`);
            } catch (error) {
                alert(`‚ùå BATTERY API TEST FAILED\n\nError: ${error.message}`);
            }
        }

        function showApiInfo() {
            alert(`‚ÑπÔ∏è API INFORMATION\n\nBase URL: ${API_BASE}\nBattery Endpoint: /battery\nDevice Status: /child/status/{device_id}\nBattery Update: /battery/update\nBattery History: /battery/history/{device_id}\nBattery Stats: /battery/stats`);
        }

        function exportBatteryReport() {
            const report = batteryData.map(device => 
                `${device.device_name} | Battery: ${device.battery_level}% | Charging: ${device.is_charging} | Health: ${device.battery_health}% | Temp: ${device.temperature}¬∞C`
            ).join('\n');
            
            alert(`üìä BATTERY REPORT\n\n${report}\n\nTotal Devices: ${batteryData.length}\nAverage Battery: ${Math.round(batteryData.reduce((sum, d) => sum + d.battery_level, 0) / batteryData.length)}%\nGenerated: ${new Date().toLocaleString()}`);
        }

        // Auto-load on page load
        document.addEventListener('DOMContentLoaded', loadRealBatteryData);

        // Auto-refresh every 60 seconds
        setInterval(loadRealBatteryData, 60000);
    </script>
</body>
</html>
