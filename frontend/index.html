<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Parental Control Panel - Battery Monitoring</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: Arial, sans-serif; background: #f5f5f5; padding: 20px; }
        .container { max-width: 900px; margin: 0 auto; background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        
        .dashboard-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 2px solid #e9ecef; }
        .child-item { border: 1px solid #e9ecef; padding: 20px; margin: 15px 0; border-radius: 10px; background: #fafafa; transition: all 0.3s ease; }
        .child-item:hover { box-shadow: 0 4px 15px rgba(0,0,0,0.1); transform: translateY(-2px); }
        
        .btn { padding: 10px 20px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; transition: all 0.3s ease; }
        .btn-control { background: linear-gradient(135deg, #007bff, #0056b3); color: white; }
        .btn-refresh { background: linear-gradient(135deg, #28a745, #1e7e34); color: white; }
        .btn-battery { background: linear-gradient(135deg, #ffc107, #e0a800); color: black; }
        .btn-simulate { background: linear-gradient(135deg, #6f42c1, #5a2d9c); color: white; }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.2); }
        
        .battery-container { margin: 15px 0; }
        .battery-level { 
            width: 100%; 
            height: 25px; 
            background: #f8f9fa; 
            border-radius: 12px; 
            overflow: hidden; 
            position: relative;
            border: 2px solid #dee2e6;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
        }
        .battery-fill { 
            height: 100%; 
            border-radius: 10px; 
            transition: all 0.5s ease;
            position: relative;
        }
        .battery-fill::after {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            bottom: 0;
            width: 5px;
            background: rgba(255,255,255,0.3);
            border-radius: 0 10px 10px 0;
        }
        .battery-high { background: linear-gradient(90deg, #28a745, #34ce57, #28a745); }
        .battery-medium { background: linear-gradient(90deg, #ffc107, #ffd54f, #ffc107); }
        .battery-low { background: linear-gradient(90deg, #dc3545, #e74c3c, #dc3545); }
        .battery-charging { 
            background: linear-gradient(90deg, #17a2b8, #20c997, #17a2b8);
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.8; }
            100% { opacity: 1; }
        }
        
        .battery-info { 
            display: flex; 
            justify-content: space-between; 
            margin-top: 8px; 
            font-size: 14px; 
            color: #495057;
            font-weight: bold;
        }
        
        .device-details { display: flex; justify-content: space-between; align-items: flex-start; }
        .device-info { flex: 1; }
        .device-actions { display: flex; flex-direction: column; gap: 10px; min-width: 150px; }
        
        .status-indicator { 
            padding: 6px 12px; 
            border-radius: 20px; 
            font-size: 12px; 
            font-weight: bold;
            display: inline-block;
            margin: 5px 0;
        }
        .status-online { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .status-offline { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .status-charging { 
            background: #d1ecf1; 
            color: #0c5460; 
            border: 1px solid #bee5eb;
            animation: blink 1.5s infinite;
        }
        
        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        
        .device-stats { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); 
            gap: 10px; 
            margin: 15px 0;
            background: white;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #e9ecef;
        }
        
        .stat-item { text-align: center; padding: 10px; }
        .stat-value { font-size: 24px; font-weight: bold; color: #007bff; }
        .stat-label { font-size: 12px; color: #6c757d; margin-top: 5px; }
        
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 8px;
            color: white;
            font-weight: bold;
            z-index: 1000;
            animation: slideIn 0.5s ease;
        }
        
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        .notification.success { background: linear-gradient(135deg, #28a745, #20c997); }
        .notification.warning { background: linear-gradient(135deg, #ffc107, #fd7e14); }
        .notification.error { background: linear-gradient(135deg, #dc3545, #e83e8c); }
        
        .device-header { 
            display: flex; 
            align-items: center; 
            gap: 10px; 
            margin-bottom: 10px;
        }
        
        .device-icon { 
            font-size: 24px; 
            background: #007bff; 
            color: white; 
            padding: 8px; 
            border-radius: 8px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="dashboard-header">
            <div>
                <h1>üîã Parental Control - Battery Monitor</h1>
                <p style="color: #6c757d; margin-top: 5px;">Real-time battery monitoring for connected devices</p>
            </div>
            <div style="display: flex; gap: 10px;">
                <button class="btn btn-refresh" onclick="loadDevices()">üîÑ Refresh</button>
                <button class="btn btn-battery" onclick="checkAllBatteries()">üîã Check All</button>
                <button class="btn btn-simulate" onclick="simulateBatteryUpdate()">‚ö° Simulate</button>
            </div>
        </div>

        <div style="background: linear-gradient(135deg, #e3f2fd, #bbdefb); padding: 15px; border-radius: 10px; margin: 20px 0; border-left: 4px solid #2196f3;">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <div>
                    <strong>üì° API Status: Connected</strong>
                    <div style="font-size: 12px; color: #1565c0;">https://sukh-hacker-x4ry.onrender.com</div>
                </div>
                <div style="text-align: right;">
                    <div style="font-size: 12px; color: #1565c0;">Real Device: <code>3fdf8d3a862a48b4</code></div>
                    <div style="font-size: 12px; color: #1565c0;">Using simulated battery data</div>
                </div>
            </div>
        </div>

        <!-- Device Statistics -->
        <div class="device-stats" id="deviceStats">
            <div class="stat-item">
                <div class="stat-value" id="totalDevices">0</div>
                <div class="stat-label">Total Devices</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="avgBattery">0%</div>
                <div class="stat-label">Avg Battery</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="chargingCount">0</div>
                <div class="stat-label">Charging</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="lowBatteryCount">0</div>
                <div class="stat-label">Low Battery</div>
            </div>
        </div>

        <div class="dashboard">
            <h3 style="color: #495057; margin-bottom: 20px;">üì± Connected Devices</h3>
            <div id="childrenList">
                <div style="text-align: center; padding: 40px; color: #6c757d;">
                    <div style="font-size: 48px; margin-bottom: 10px;">üîã</div>
                    <h4>Loading devices and battery information...</h4>
                    <p>Fetching data from parental control API</p>
                </div>
            </div>
        </div>

        <div style="margin-top: 30px; padding: 20px; background: linear-gradient(135deg, #f8f9fa, #e9ecef); border-radius: 10px;">
            <h4>üîß Device Management</h4>
            <div style="display: flex; gap: 10px; margin-top: 15px; flex-wrap: wrap;">
                <button class="btn btn-control" onclick="addDeviceWithBattery()">‚ûï Add Device</button>
                <button class="btn btn-control" onclick="toggleAllCharging()">üîå Toggle Charging</button>
                <button class="btn btn-control" onclick="setAllBatteries(100)">‚ö° Charge All to 100%</button>
                <button class="btn btn-control" onclick="exportBatteryReport()">üìä Export Report</button>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = "https://sukh-hacker-x4ry.onrender.com";
        let devices = [];

        // Show notification
        function showNotification(message, type = 'success') {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                document.body.removeChild(notification);
            }, 3000);
        }

        // Load devices with simulated battery data
        async function loadDevices() {
            try {
                showNotification('üîÑ Loading devices...', 'warning');
                
                const response = await fetch(`${API_BASE}/debug/children`);
                const data = await response.json();
                
                // Initialize devices with simulated battery data
                devices = (data.children || []).map(device => {
                    const batteryLevel = generateRealisticBatteryLevel(device.created_at);
                    return {
                        ...device,
                        battery_level: batteryLevel,
                        is_charging: Math.random() > 0.7 && batteryLevel < 90,
                        last_update: new Date().toISOString(),
                        battery_health: Math.floor(Math.random() * 20) + 80, // 80-100% health
                        temperature: Math.floor(Math.random() * 15) + 25, // 25-40¬∞C
                        voltage: (Math.random() * 0.5 + 3.7).toFixed(2) + 'V' // 3.7-4.2V
                    };
                });
                
                renderDevices();
                updateStatistics();
                showNotification(`‚úÖ Loaded ${devices.length} devices`, 'success');
                
            } catch (error) {
                showNotification(`‚ùå Error loading devices: ${error.message}`, 'error');
            }
        }

        // Generate realistic battery level based on device age
        function generateRealisticBatteryLevel(createdAt) {
            const created = new Date(createdAt);
            const now = new Date();
            const ageInDays = (now - created) / (1000 * 60 * 60 * 24);
            
            // Older devices tend to have lower battery levels
            let baseLevel = Math.floor(Math.random() * 50) + 20;
            if (ageInDays > 30) baseLevel -= 10;
            if (ageInDays > 90) baseLevel -= 15;
            
            return Math.max(5, Math.min(100, baseLevel));
        }

        // Get battery class and icon
        function getBatteryClass(level, isCharging) {
            if (isCharging) return 'battery-charging';
            if (level > 70) return 'battery-high';
            if (level > 30) return 'battery-medium';
            return 'battery-low';
        }

        function getBatteryIcon(level, isCharging) {
            if (isCharging) return 'üîå';
            if (level > 80) return 'üîã';
            if (level > 50) return 'üîã';
            if (level > 20) return 'ü™´';
            return 'ü™´';
        }

        // Render devices with battery information
        function renderDevices() {
            const childrenList = document.getElementById('childrenList');
            
            if (devices.length === 0) {
                childrenList.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #6c757d;">
                        <div style="font-size: 64px; margin-bottom: 20px;">üì±</div>
                        <h4>No Devices Connected</h4>
                        <p>Add a device to start monitoring battery levels</p>
                        <button class="btn btn-control" onclick="addDeviceWithBattery()" style="margin-top: 20px;">
                            ‚ûï Add Your First Device
                        </button>
                    </div>
                `;
                return;
            }
            
            childrenList.innerHTML = devices.map(device => `
                <div class="child-item">
                    <div class="device-details">
                        <div class="device-info">
                            <div class="device-header">
                                <div class="device-icon">${getDeviceIcon(device.device_model)}</div>
                                <div>
                                    <h4 style="margin: 0; color: #343a40;">${device.name}</h4>
                                    <div style="font-size: 12px; color: #6c757d;">
                                        ${device.device_model} ‚Ä¢ ID: ${device.device_id.substring(0, 8)}...
                                    </div>
                                </div>
                            </div>
                            
                            <div class="battery-container">
                                <div class="battery-info">
                                    <span>${getBatteryIcon(device.battery_level, device.is_charging)} Battery Level</span>
                                    <span>
                                        <strong>${device.battery_level}%</strong>
                                        ${device.is_charging ? '‚ö° Charging' : ''}
                                    </span>
                                </div>
                                <div class="battery-level">
                                    <div class="battery-fill ${getBatteryClass(device.battery_level, device.is_charging)}" 
                                         style="width: ${device.battery_level}%"></div>
                                </div>
                                <div class="battery-info">
                                    <span>Updated: ${new Date(device.last_update).toLocaleTimeString()}</span>
                                    <span class="status-indicator ${device.is_charging ? 'status-charging' : device.is_blocked ? 'status-offline' : 'status-online'}">
                                        ${device.is_charging ? '‚ö° Charging' : device.is_blocked ? 'üö´ Blocked' : '‚úÖ Online'}
                                    </span>
                                </div>
                            </div>
                            
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 10px; margin-top: 15px;">
                                <div style="text-align: center; padding: 8px; background: #f8f9fa; border-radius: 6px;">
                                    <div style="font-size: 12px; color: #6c757d;">Health</div>
                                    <div style="font-weight: bold; color: #28a745;">${device.battery_health}%</div>
                                </div>
                                <div style="text-align: center; padding: 8px; background: #f8f9fa; border-radius: 6px;">
                                    <div style="font-size: 12px; color: #6c757d;">Temp</div>
                                    <div style="font-weight: bold; color: #fd7e14;">${device.temperature}¬∞C</div>
                                </div>
                                <div style="text-align: center; padding: 8px; background: #f8f9fa; border-radius: 6px;">
                                    <div style="font-size: 12px; color: #6c757d;">Voltage</div>
                                    <div style="font-weight: bold; color: #6f42c1;">${device.voltage}</div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="device-actions">
                            <button class="btn btn-control" onclick="viewDeviceStatus('${device.device_id}')">
                                üìä Status
                            </button>
                            <button class="btn btn-battery" onclick="updateBattery('${device.device_id}')">
                                üîã Update
                            </button>
                            <button class="btn" style="background: #6c757d; color: white;" onclick="toggleCharging('${device.device_id}')">
                                ${device.is_charging ? '‚èπÔ∏è Stop Charge' : 'üîå Start Charge'}
                            </button>
                            <button class="btn" style="background: #dc3545; color: white;" onclick="showBatteryAlert('${device.device_id}')">
                                üö® Alert
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // Update device statistics
        function updateStatistics() {
            const totalDevices = devices.length;
            const avgBattery = totalDevices > 0 
                ? Math.round(devices.reduce((sum, device) => sum + device.battery_level, 0) / totalDevices)
                : 0;
            const chargingCount = devices.filter(device => device.is_charging).length;
            const lowBatteryCount = devices.filter(device => device.battery_level <= 20).length;
            
            document.getElementById('totalDevices').textContent = totalDevices;
            document.getElementById('avgBattery').textContent = avgBattery + '%';
            document.getElementById('chargingCount').textContent = chargingCount;
            document.getElementById('lowBatteryCount').textContent = lowBatteryCount;
        }

        // Device icon mapping
        function getDeviceIcon(model) {
            const modelLower = model.toLowerCase();
            if (modelLower.includes('iphone') || modelLower.includes('ios')) return 'üì±';
            if (modelLower.includes('samsung')) return 'üì±';
            if (modelLower.includes('android')) return 'üì±';
            if (modelLower.includes('ipad') || modelLower.includes('tablet')) return 'üíª';
            if (modelLower.includes('watch')) return '‚åö';
            return 'üì±';
        }

        // Update battery for specific device
        function updateBattery(deviceId) {
            const device = devices.find(d => d.device_id === deviceId);
            if (device) {
                const oldLevel = device.battery_level;
                device.battery_level = generateRealisticBatteryLevel(device.created_at);
                device.last_update = new Date().toISOString();
                device.is_charging = device.battery_level < oldLevel ? Math.random() > 0.5 : device.is_charging;
                
                renderDevices();
                updateStatistics();
                
                showNotification(`üîã ${device.name} battery updated: ${oldLevel}% ‚Üí ${device.battery_level}%`, 'success');
            }
        }

        // Check all batteries
        function checkAllBatteries() {
            showNotification('üîã Checking all device batteries...', 'warning');
            
            devices.forEach(device => {
                device.battery_level = generateRealisticBatteryLevel(device.created_at);
                device.last_update = new Date().toISOString();
            });
            
            renderDevices();
            updateStatistics();
            showNotification(`‚úÖ Updated battery levels for ${devices.length} devices`, 'success');
        }

        // Simulate battery changes
        function simulateBatteryUpdate() {
            devices.forEach(device => {
                const change = Math.floor(Math.random() * 15) - 7; // -7 to +7 change
                device.battery_level = Math.max(5, Math.min(100, device.battery_level + change));
                device.is_charging = device.battery_level < 25 ? Math.random() > 0.3 : 
                                   device.battery_level > 95 ? false : device.is_charging;
                device.last_update = new Date().toISOString();
            });
            
            renderDevices();
            updateStatistics();
            showNotification('‚ö° Simulated battery changes applied', 'success');
        }

        // Toggle charging for device
        function toggleCharging(deviceId) {
            const device = devices.find(d => d.device_id === deviceId);
            if (device) {
                device.is_charging = !device.is_charging;
                device.last_update = new Date().toISOString();
                renderDevices();
                
                showNotification(
                    `${device.is_charging ? 'üîå Started' : '‚èπÔ∏è Stopped'} charging for ${device.name}`,
                    'warning'
                );
            }
        }

        // Toggle all charging
        function toggleAllCharging() {
            const allCharging = devices.every(device => device.is_charging);
            devices.forEach(device => {
                device.is_charging = !allCharging;
                device.last_update = new Date().toISOString();
            });
            
            renderDevices();
            updateStatistics();
            showNotification(
                `${allCharging ? '‚èπÔ∏è Stopped' : 'üîå Started'} charging for all devices`,
                'warning'
            );
        }

        // Set all batteries to specific level
        function setAllBatteries(level) {
            devices.forEach(device => {
                device.battery_level = level;
                device.is_charging = level < 100;
                device.last_update = new Date().toISOString();
            });
            
            renderDevices();
            updateStatistics();
            showNotification(`‚ö° All batteries set to ${level}%`, 'success');
        }

        // Show battery alert
        function showBatteryAlert(deviceId) {
            const device = devices.find(d => d.device_id === deviceId);
            if (device) {
                alert(`üö® BATTERY ALERT\n\nDevice: ${device.name}\nBattery: ${device.battery_level}%\nStatus: ${device.is_charging ? 'Charging' : 'Discharging'}\n\nAction Required: ${device.battery_level <= 15 ? 'CHARGE IMMEDIATELY' : 'Monitor battery level'}`);
            }
        }

        // Add test device with battery
        async function addDeviceWithBattery() {
            const deviceName = prompt('Enter device name:', 'My Android Phone');
            if (!deviceName) return;
            
            try {
                const response = await fetch(`${API_BASE}/debug/add_test_device`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ device_name: deviceName })
                });
                
                const result = await response.json();
                
                if (result.message) {
                    // Add new device to list with realistic battery data
                    const newDevice = {
                        ...result,
                        name: deviceName,
                        device_model: "Mobile Device",
                        battery_level: 85, // New devices start with good battery
                        is_charging: false,
                        last_update: new Date().toISOString(),
                        is_blocked: false,
                        battery_health: 100,
                        temperature: 28,
                        voltage: '3.8V'
                    };
                    
                    devices.push(newDevice);
                    renderDevices();
                    updateStatistics();
                    
                    showNotification(`‚úÖ ${deviceName} added successfully!`, 'success');
                }
            } catch (error) {
                showNotification('‚ùå Error adding device: ' + error.message, 'error');
            }
        }

        // View device status
        async function viewDeviceStatus(deviceId) {
            try {
                const response = await fetch(`${API_BASE}/child/status/${deviceId}`);
                const status = await response.json();
                
                const device = devices.find(d => d.device_id === deviceId);
                if (device) {
                    alert(`üì± DEVICE STATUS\n\nName: ${status.name}\nBlocked: ${status.is_blocked ? 'Yes' : 'No'}\nBattery: ${device.battery_level}%\nCharging: ${device.is_charging ? 'Yes' : 'No'}\nHealth: ${device.battery_health}%\nTemperature: ${device.temperature}¬∞C\nVoltage: ${device.voltage}\n\nLast Update: ${new Date(device.last_update).toLocaleString()}`);
                }
            } catch (error) {
                alert('Error getting device status: ' + error.message);
            }
        }

        // Export battery report
        function exportBatteryReport() {
            const report = devices.map(device => 
                `${device.name} | Battery: ${device.battery_level}% | Charging: ${device.is_charging} | Health: ${device.battery_health}%`
            ).join('\n');
            
            alert(`üîã BATTERY REPORT\n\n${report}\n\nTotal Devices: ${devices.length}\nAverage Battery: ${Math.round(devices.reduce((sum, d) => sum + d.battery_level, 0) / devices.length)}%\nGenerated: ${new Date().toLocaleString()}`);
        }

        // Auto-load on page load
        document.addEventListener('DOMContentLoaded', loadDevices);

        // Auto-refresh battery every 45 seconds
        setInterval(() => {
            if (devices.length > 0) {
                devices.forEach(device => {
                    // Simulate realistic battery drain/charge
                    if (device.is_charging && device.battery_level < 100) {
                        device.battery_level = Math.min(100, device.battery_level + 2);
                    } else if (!device.is_charging && device.battery_level > 5) {
                        device.battery_level = Math.max(5, device.battery_level - 1);
                    }
                    device.last_update = new Date().toISOString();
                });
                renderDevices();
                updateStatistics();
            }
        }, 45000);
    </script>
</body>
</html>
