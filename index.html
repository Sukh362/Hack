<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ParentGuard Panel</title>

  <!-- Leaflet (map) -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-sA+4gXv6tGv3gkV7xQzX+3Zkq4Qv3m5tY7f6k6o0b+8=" crossorigin=""/>
  <style>
    body { font-family: Arial, Helvetica, sans-serif; margin:0; padding:0; background:#f6f8fa; }
    header { background:#0b5ed7; color:#fff; padding:12px 18px; display:flex; align-items:center; justify-content:space-between; }
    header h1 { font-size:18px; margin:0; }
    .container { display:flex; gap:16px; padding:16px; }
    .left { width:380px; background:#fff; border-radius:8px; padding:12px; box-shadow:0 2px 6px rgba(0,0,0,0.08); height:80vh; overflow:auto; }
    .right { flex:1; background:#fff; border-radius:8px; padding:8px; box-shadow:0 2px 6px rgba(0,0,0,0.08); height:80vh; }
    .device { border-bottom:1px solid #eee; padding:8px 4px; display:flex; gap:8px; align-items:center; }
    .dev-info { flex:1; }
    .dev-id { font-weight:700; font-size:13px; }
    .small { color:#666; font-size:12px; }
    button { background:#0b5ed7; color:#fff; border:0; padding:6px 8px; border-radius:6px; cursor:pointer; }
    button.ghost { background:#eee; color:#333; }
    #map { height:100%; min-height:520px; border-radius:6px; }
    .top-controls { display:flex; gap:8px; align-items:center; }
    .status { font-size:13px; padding:4px 8px; border-radius:6px; background:#eef6ff; color:#0b5ed7; }
    .footer { padding:8px 16px; color:#777; font-size:13px; }
  </style>
</head>
<body>

<header>
  <h1>ParentGuard — Panel</h1>
  <div class="top-controls">
    <div class="status" id="connStatus">Disconnected</div>
    <button id="refreshBtn" class="ghost">Refresh</button>
  </div>
</header>

<div class="container">
  <div class="left">
    <div style="margin-bottom:8px;">
      <strong>Devices</strong>
      <div class="small">Showing realtime devices under <code>/devices</code></div>
    </div>
    <div id="devicesList">
      <!-- devices will be injected here -->
    </div>
  </div>

  <div class="right">
    <div id="map"></div>
  </div>
</div>

<div class="footer">Tip: Use browser console for debug logs. Make sure this page is served over HTTP(S) (eg. `python -m http.server`).</div>

<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
  integrity="sha256-o9N1j7gRk7lB8sS6n0bNyKQx3vKq9c3bV4Jd2x0vX2Q=" crossorigin=""></script>

<!-- Firebase JS (compat - simple API) -->
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

<script>
/* ============================
   1) CONFIGURE FIREBASE
   ============================
   Replace the firebaseConfig object below with your Web app config which you get from:
   Firebase Console → Project Settings → SDK setup and configuration → "Config" (for Web)
   Example form:
   const firebaseConfig = {
     apiKey: "AAAA...X",
     authDomain: "project-id.firebaseapp.com",
     databaseURL: "https://project-id-default-rtdb.firebaseio.com",
     projectId: "project-id",
     storageBucket: "project-id.appspot.com",
     messagingSenderId: "1234567890",
     appId: "1:1234567890:web:abcdef"
   };
*/
const firebaseConfig = {
  // <-- PASTE YOUR WEB CONFIG HERE
};

/* If you only have google-services.json (android) you can still:
   - open google-services.json and copy project_info.project_id and database url if present,
   - but easiest: open Firebase Console -> Project Settings -> Add Web App -> copy config.
*/

// init firebase
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

/* ============================
   2) MAP (Leaflet)
   ============================ */
const map = L.map('map').setView([20.5937, 78.9629], 5); // India default
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  maxZoom: 19,
  attribution: '© OpenStreetMap'
}).addTo(map);

const markers = {}; // deviceId -> marker

/* ============================
   3) UI helpers
   ============================ */
const connStatus = document.getElementById('connStatus');
const devicesList = document.getElementById('devicesList');
const refreshBtn = document.getElementById('refreshBtn');

function setStatus(text, ok=true) {
  connStatus.textContent = text;
  connStatus.style.background = ok ? '#eef6ff' : '#ffeef0';
  connStatus.style.color = ok ? '#0b5ed7' : '#c00';
}

function formatTs(ts) {
  try {
    const d = new Date(ts);
    return d.toLocaleString();
  } catch (_) { return ts; }
}

/* ============================
   4) Render device entry
   ============================ */
function renderDevices(devicesObj) {
  devicesList.innerHTML = '';
  if (!devicesObj) {
    devicesList.innerHTML = '<div class="small">No devices found under /devices</div>';
    return;
  }
  const keys = Object.keys(devicesObj).sort();
  keys.forEach(deviceId => {
    const dev = devicesObj[deviceId] || {};
    const loc = dev.location || {};
    const battery = dev.battery || {};
    const lastTs = loc.ts || battery.ts || dev.ts || null;
    const lat = loc.lat, lng = loc.lng;
    // device card
    const div = document.createElement('div');
    div.className = 'device';
    div.innerHTML = `
      <div class="dev-info">
        <div class="dev-id">${deviceId}</div>
        <div class="small">Lat: ${lat ?? '-'} &nbsp; Lng: ${lng ?? '-'} &nbsp; • Battery: ${battery.level ?? '-'}%</div>
        <div class="small">Updated: ${ lastTs ? formatTs(lastTs) : '-' }</div>
      </div>
      <div style="display:flex;flex-direction:column;gap:6px;">
        <button onclick="focusDevice('${deviceId}')">Show on map</button>
        <button onclick="requestLocation('${deviceId}')" class="ghost">Request location</button>
      </div>
    `;
    devicesList.appendChild(div);

    // map marker
    if (lat != null && lng != null) {
      const latN = parseFloat(lat), lngN = parseFloat(lng);
      if (!isNaN(latN) && !isNaN(lngN)) {
        if (markers[deviceId]) {
          markers[deviceId].setLatLng([latN, lngN]);
        } else {
          const m = L.marker([latN, lngN]).addTo(map).bindPopup(`<b>${deviceId}</b><br>${formatTs(lastTs)}`);
          markers[deviceId] = m;
        }
      }
    }
  });
}

/* ============================
   5) Realtime listener
   ============================ */
function startRealtime() {
  setStatus('Connecting...');
  const ref = db.ref('devices');
  ref.on('value', snapshot => {
    const val = snapshot.val();
    renderDevices(val);
    setStatus('Connected', true);
  }, err => {
    console.error('Firebase listen error', err);
    setStatus('Error', false);
  });
}

refreshBtn.addEventListener('click', () => {
  // simple manual refresh: fetch once
  db.ref('devices').once('value').then(snap => {
    renderDevices(snap.val());
  });
});

/* ============================
   6) Commands: write a command node for a device
   ============================ */
function requestLocation(deviceId) {
  if (!confirm('Send location request to device: ' + deviceId + ' ?')) return;
  // write a command under devices/{deviceId}/commands/get_location = true
  const cmdRef = db.ref(`devices/${deviceId}/commands/get_location`);
  // set true with a timestamp (child app should watch this path and reset it)
  cmdRef.set({ value: true, ts: Date.now() })
    .then(() => alert('Request sent'))
    .catch(err => alert('Failed to send: ' + err));
}

/* ============================
   7) Start
   ============================ */
startRealtime();
setStatus('Connecting...', true);

// Expose some helpers to window for inline onclick
window.focusDevice = function(deviceId) {
  const devNode = document.querySelectorAll('.dev-id');
  const marker = markers[deviceId];
  if (marker) {
    map.setView(marker.getLatLng(), 16);
    marker.openPopup();
  } else {
    alert('No location available for ' + deviceId);
  }
};
window.requestLocation = requestLocation;
</script>
</body>
</html>
