<!DOCTYPE html>
<html lang="hi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Admin Panel ‚Äì Battery + Location + Camera + Torch</title>
  <style>
    :root { --bg:#0b1220; --card:#121a2b; --text:#e6eefc; --muted:#9bb0d6; }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial}
    .wrap{max-width:820px;margin:32px auto;padding:20px}
    .card{background:var(--card);border:1px solid #1e2a44;border-radius:16px;padding:20px;box-shadow:0 8px 24px rgba(0,0,0,.25)}
    h1{margin:0 0 8px;font-weight:700;font-size:28px}
    p{margin:6px 0;color:var(--muted)}
    .row{display:flex;gap:14px;flex-wrap:wrap;margin:18px 0}
    .input,button{background:#0e1627;color:var(--text);border:1px solid #25324c;border-radius:12px;padding:10px 14px;font-size:14px}
    button{cursor:pointer}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:16px}
    .tile{background:#0e1627;border:1px solid #25324c;border-radius:14px;padding:14px}
    .big{font-size:44px;font-weight:800;letter-spacing:1px}
    .ok{color:#6ee7a9} .low{color:#f59f85} .crit{color:#fb7185}
    .list{max-height:260px;overflow:auto;border:1px dashed #2a395d;border-radius:12px;padding:8px}
    .item{display:flex;justify-content:space-between;padding:8px 10px;border-bottom:1px solid #1a2540}
    .item:last-child{border-bottom:0}
    .ts{color:#90a7cf;font-variant-numeric:tabular-nums}
    .popup {
      display: none;
      position: fixed;
      top: 50%; left: 50%;
      transform: translate(-50%, -50%);
      background: #0a223d;
      border: 2px solid #00e0ff;
      padding: 20px;
      border-radius: 15px;
      text-align: center;
      color: #00e0ff;
      box-shadow: 0 0 25px #00e0ff;
      z-index: 9999;
    }
    .popup iframe, .popup img {
      width: 320px;
      height: 320px;
      border-radius: 10px;
      margin-top: 10px;
      object-fit: cover;
    }
    .close-btn {
      background: #ff004c;
      border: none;
      padding: 10px 15px;
      margin-top: 15px;
      color: white;
      border-radius: 10px;
      cursor: pointer;
    }
  </style>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>Battery + Location + Camera + Torch</h1>
      <p>Firebase ‡§∏‡•á live data</p>

      <div class="row">
        <label>
          <div style="margin-bottom:6px;color:#9bb0d6">Child Path</div>
          <input id="path" class="input" style="width:260px" value="ParentGuard/users/child1" />
        </label>
        <button id="connect">üîã Connect Battery</button>
        <button onclick="showLocation()">üìç Show Location</button>
        <button onclick="takePhoto()">üì∑ Take Photo</button>
        <button onclick="torchOn()">üí° Torch ON</button>
        <button onclick="torchOff()">‚ùå Torch OFF</button>
        <span id="status" style="align-self:center;color:#9bb0d6">Not connected</span>
      </div>

      <div class="grid">
        <div class="tile">
          <div style="color:#9bb0d6">Current Battery</div>
          <div id="battery" class="big">--%</div>
          <div id="lastUpdate" class="ts">‚Äî</div>
        </div>
        <div class="tile">
          <div style="color:#9bb0d6">Health</div>
          <div id="health" class="big">‚Äî</div>
          <div class="ts">Auto-classified</div>
        </div>
      </div>

      <h3 style="margin:18px 0 8px">Recent Entries</h3>
      <div id="list" class="list"></div>
    </div>
  </div>

  <!-- Location Popup -->
  <div id="locationPopup" class="popup">
    <h2>User Location</h2>
    <p id="locationText">Fetching location...</p>
    <iframe id="mapFrame"></iframe><br>
    <button class="close-btn" onclick="closePopup('locationPopup')">Close</button>
  </div>

  <!-- Camera Popup -->
  <div id="cameraPopup" class="popup">
    <h2>User Camera</h2>
    <p id="cameraStatus">Waiting for photo...</p>
    <img id="cameraImage" src="" alt="User photo"/>
    <br>
    <button class="close-btn" onclick="closePopup('cameraPopup')">Close</button>
  </div>

  <script>
    // Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyBeNsxHh_EvN-9E7Tp3c96lU7cq0FhZNqg",
      authDomain: "https://hackapp-aff40.firebaseapp.com/__/auth/handler",
      databaseURL: "https://hackapp-aff40-default-rtdb.firebaseio.com",
      projectId: "hackapp-aff40",
      storageBucket: "hackapp-aff40.firebasestorage.app",
      messagingSenderId: "1000037921919",
      appId: "1:1000037921919:android:26df39932d4695def63b4a"
    };

    const app = firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    const ui = {
      status: document.getElementById('status'),
      battery: document.getElementById('battery'),
      last: document.getElementById('lastUpdate'),
      health: document.getElementById('health'),
      list: document.getElementById('list'),
      path: document.getElementById('path'),
      connect: document.getElementById('connect')
    };

    let currentRef = null;

    function classify(level){
      if(level == null || isNaN(level)) return {label:'‚Äî', cls:''};
      const n = Number(level);
      if(n >= 80) return {label:'OK', cls:'ok'};
      if(n >= 30) return {label:'LOW', cls:'low'};
      return {label:'CRITICAL', cls:'crit'};
    }

    function attach(path){
      if(currentRef) currentRef.off();
      ui.status.textContent = 'Connecting‚Ä¶';
      const ref = db.ref(path);
      currentRef = ref;

      ref.limitToLast(20).on('value', snap => {
        const data = snap.val() || {};
        const items = Object.entries(data);
        items.sort((a,b)=> a[0].localeCompare(b[0]));

        ui.list.innerHTML = '';
        let lastVal = null, lastKey = null;
        for(const [key, val] of items){
          const b = (val && (val.battery ?? val.level ?? val.Battery ?? val.BATTERY));
          const row = document.createElement('div');
          row.className = 'item';
          row.innerHTML = `<span>üîã ${b ?? '‚Äî'}%</span><span class="ts">${key}</span>`;
          ui.list.appendChild(row);
          lastVal = b; lastKey = key;
        }

        if(lastVal != null){
          ui.battery.textContent = `${lastVal}%`;
          const c = classify(lastVal);
          ui.health.textContent = c.label;
          ui.health.className = 'big ' + c.cls;
          ui.last.textContent = `Last update: ${lastKey}`;
          ui.status.textContent = 'Live';
        } else {
          ui.battery.textContent = '--%';
          ui.health.textContent = '‚Äî';
          ui.health.className = 'big';
          ui.last.textContent = 'No data yet';
          ui.status.textContent = 'Waiting for data‚Ä¶';
        }
      });
    }

    ui.connect.addEventListener('click', ()=> attach(ui.path.value.trim()));

    // Location popup
    function showLocation() {
      let popup = document.getElementById("locationPopup");
      popup.style.display = "block";

      db.ref(ui.path.value.trim() + "/location").once("value").then(snap=>{
        const loc = snap.val();
        if(loc && loc.lat && loc.lon){
          document.getElementById("locationText").innerText = `Lat: ${loc.lat}, Lon: ${loc.lon}`;
          document.getElementById("mapFrame").src = `https://www.google.com/maps?q=${loc.lat},${loc.lon}&z=15&output=embed`;
        } else {
          document.getElementById("locationText").innerText = "Location not available!";
        }
      });
    }

    // Camera popup
    function takePhoto(){
      let popup = document.getElementById("cameraPopup");
      popup.style.display = "block";
      document.getElementById("cameraStatus").innerText = "Requesting photo...";
      db.ref("commands").update({camera:true});
    }

    // Torch control
    function torchOn(){
      db.ref("commands").update({torch:true});
      alert("Torch ON command sent!");
    }

    function torchOff(){
      db.ref("commands").update({torch:false});
      alert("Torch OFF command sent!");
    }

    // Listen for uploaded photo URL
    db.ref("camera_result").on("value", snap=>{
      const url = snap.val();
      if(url){
        document.getElementById("cameraStatus").innerText = "Photo received:";
        document.getElementById("cameraImage").src = url;
      }
    });

    function closePopup(id) {
      document.getElementById(id).style.display = "none";
    }
  </script>
</body>
</html>
