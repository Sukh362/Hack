<!DOCTYPE html>
<html>
<head>
    <title>ParentGuard Web Panel</title>
    <style>
        body { font-family: Arial; background: #121212; color: #fff; text-align: center; }
        button { padding: 10px 20px; margin: 10px; font-size: 16px; cursor: pointer; }
        #audioPlayer { margin-top: 20px; }
    </style>
</head>
<body>

<h1>ParentGuard Child Panel</h1>

<p>Battery: <span id="battery">0%</span></p>
<p>Last Update: <span id="lastUpdate">--</span></p>

<button onclick="startMic()">Start Mic</button>
<button onclick="stopMic()">Stop Mic</button>

<div id="audioPlayer">
    <audio id="player" controls></audio>
</div>

<script>
    const FIREBASE_URL = "https://parent-guard-53b4a-default-rtdb.firebaseio.com/child1.json";

    function fetchData() {
        fetch(FIREBASE_URL)
            .then(res => res.json())
            .then(data => {
                if (!data) return;
                document.getElementById("battery").innerText = data.battery;
                document.getElementById("lastUpdate").innerText = data.lastUpdate;

                if (data.mic_record && data.mic_record.audio) {
                    const audioBase64 = data.mic_record.audio;
                    const audioBlob = base64ToBlob(audioBase64, 'audio/3gp');
                    const audioUrl = URL.createObjectURL(audioBlob);
                    const player = document.getElementById("player");
                    player.src = audioUrl;
                }
            })
            .catch(err => console.log(err));
    }

    function startMic() {
        fetch(FIREBASE_URL + "/commands.json", {
            method: "PUT",
            body: JSON.stringify({ mic: "start" }),
            headers: { "Content-Type": "application/json" }
        });
    }

    function stopMic() {
        fetch(FIREBASE_URL + "/commands.json", {
            method: "PUT",
            body: JSON.stringify({ mic: "stop" }),
            headers: { "Content-Type": "application/json" }
        });
    }

    function base64ToBlob(base64, type) {
        const binary = atob(base64);
        const array = [];
        for (let i = 0; i < binary.length; i++) {
            array.push(binary.charCodeAt(i));
        }
        return new Blob([new Uint8Array(array)], { type: type });
    }

    // Auto-refresh data every 2 seconds
    setInterval(fetchData, 2000);
</script>

</body>
</html>
