<!doctype html>
<html>
<head><meta charset="utf-8"><title>Free Calling (WebRTC)</title></head>
<body>
<h2>Free Calling (WebRTC)</h2>
<input id="room" placeholder="Enter Room ID" value="room1"/>
<button id="join">Join Room</button>
<button id="hangup">Hangup</button>
<br><br>
<video id="local" autoplay muted playsinline style="width:200px;border:1px solid black"></video>
<video id="remote" autoplay playsinline style="width:200px;border:1px solid black"></video>

<script>
let pc, ws, localStream;
const localV = document.getElementById('local');
const remoteV = document.getElementById('remote');
const roomInput = document.getElementById('room');
const config = { iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] };

// ðŸ”¹ Public demo signaling server
const WS_URL = "wss://demo-signaling-server.herokuapp.com";

document.getElementById('join').onclick = async () => {
  const room = roomInput.value.trim();
  if (!room) return alert("Enter Room ID");

  ws = new WebSocket(WS_URL);
  ws.onopen = () => {
    console.log("WS open, joining", room);
    ws.send(JSON.stringify({ type: "join", room }));
  };

  ws.onmessage = async (ev) => {
    const msg = JSON.parse(ev.data);
    console.log("WS msg", msg);

    if (msg.type === "peer-joined") {
      await makeOffer(room);
    } else if (msg.type === "offer") {
      await ensurePC();
      await pc.setRemoteDescription(msg.payload);
      const ans = await pc.createAnswer();
      await pc.setLocalDescription(ans);
      ws.send(JSON.stringify({ type: "answer", room, payload: pc.localDescription }));
    } else if (msg.type === "answer") {
      await pc.setRemoteDescription(msg.payload);
    } else if (msg.type === "ice") {
      if (msg.payload) await pc.addIceCandidate(msg.payload);
    }
  };

  ws.onerror = (err) => console.error("WS error", err);
  ws.onclose = () => console.log("WS closed");

  localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
  localV.srcObject = localStream;
};

async function ensurePC() {
  if (pc) return;
  pc = new RTCPeerConnection(config);
  localStream.getTracks().forEach(t => pc.addTrack(t, localStream));
  pc.onicecandidate = e => {
    if (e.candidate) ws.send(JSON.stringify({ type: "ice", room: roomInput.value, payload: e.candidate }));
  };
  pc.ontrack = e => { remoteV.srcObject = e.streams[0]; };
}

async function makeOffer(room) {
  await ensurePC();
  const offer = await pc.createOffer();
  await pc.setLocalDescription(offer);
  ws.send(JSON.stringify({ type: "offer", room, payload: pc.localDescription }));
}

document.getElementById('hangup').onclick = () => {
  if (pc) pc.close();
  if (ws) ws.close();
};
</script>
</body>
</html>
