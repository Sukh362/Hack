<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ParentGuard â€¢ Minimal Admin (Debug)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    html,body{background:#0b1220;color:#e6eefc;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto}
    .glass{backdrop-filter:blur(10px);background:linear-gradient(180deg,rgba(255,255,255,.06),rgba(255,255,255,.02));border:1px solid rgba(255,255,255,.08)}
    .ring{box-shadow:0 0 0 1px #23314f inset}
  </style>
  <!-- Firebase compat (Realtime DB) -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
</head>
<body>
  <div class="max-w-4xl mx-auto p-5 space-y-5">
    <header class="glass ring rounded-2xl p-4 flex items-center gap-3">
      <div class="w-9 h-9 rounded-xl bg-sky-500/20 grid place-items-center">
        <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 text-sky-400" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2a10 10 0 100 20 10 10 0 000-20zm1 14.59V18h-2v-1.41l-3.3-3.3 1.42-1.42L11 13.17V8h2v5.17l1.88-1.88 1.42 1.42L13 16.59z"/></svg>
      </div>
      <div>
        <h1 class="text-lg font-bold">ParentGuard â€” Minimal Admin</h1>
        <p class="text-xs text-slate-300">Battery â€¢ Location â€¢ Commands â€” with builtâ€‘in Debugger</p>
      </div>
      <div class="ml-auto text-xs text-slate-300 flex items-center gap-2"><span id="live" class="inline-flex items-center gap-2"><span class="w-2.5 h-2.5 rounded-full bg-red-400 animate-pulse"></span> Disconnected</span></div>
    </header>

    <!-- Config -->
    <section class="glass ring rounded-2xl p-4 space-y-3">
      <h2 class="text-base font-semibold">Firebase Config</h2>
      <div class="grid sm:grid-cols-2 gap-3 text-xs">
        <label>databaseURL<input id="cfgDbUrl" class="w-full bg-slate-900/60 ring rounded-xl px-3 py-2 text-sm mt-1" value="https://user-bd87e-default-rtdb.firebaseio.com"/></label>
        <label>apiKey<input id="cfgApiKey" class="w-full bg-slate-900/60 ring rounded-xl px-3 py-2 text-sm mt-1" value="AIzaSyCR5-aZKw7dKIgEzW9kKs8s7mSZ-Jd8CUs"/></label>
        <label>authDomain<input id="cfgAuthDomain" class="w-full bg-slate-900/60 ring rounded-xl px-3 py-2 text-sm mt-1" value="user-bd87e.firebaseapp.com"/></label>
        <label>projectId<input id="cfgProjectId" class="w-full bg-slate-900/60 ring rounded-xl px-3 py-2 text-sm mt-1" value="user-bd87e"/></label>
        <label>storageBucket<input id="cfgBucket" class="w-full bg-slate-900/60 ring rounded-xl px-3 py-2 text-sm mt-1" value="user-bd87e.appspot.com"/></label>
        <label>messagingSenderId<input id="cfgSender" class="w-full bg-slate-900/60 ring rounded-xl px-3 py-2 text-sm mt-1" value="365506680148"/></label>
        <label>appId<input id="cfgAppId" class="w-full bg-slate-900/60 ring rounded-xl px-3 py-2 text-sm mt-1" value="1:365506680148:android:7c3422aa52a8f6e32d24c1"/></label>
      </div>
      <div class="flex gap-2 pt-2">
        <button id="btnInit" class="px-3 py-2 rounded-xl bg-sky-500 hover:bg-sky-400 text-sm font-medium">Init / Reâ€‘Init</button>
        <button id="btnKill" class="px-3 py-2 rounded-xl bg-slate-700 hover:bg-slate-600 text-sm">Disconnect</button>
      </div>
    </section>

    <!-- Path + Actions -->
    <section class="glass ring rounded-2xl p-4 space-y-3">
      <h2 class="text-base font-semibold">Path & Actions</h2>
      <div class="grid sm:grid-cols-2 gap-3">
        <label class="text-xs">Child Path (e.g. <code>Users/child1</code>)
          <input id="childPath" class="w-full bg-slate-900/60 ring rounded-xl px-3 py-2 text-sm mt-1" value="Users/child1"/>
        </label>
        <div class="flex items-end gap-2">
          <button id="btnConnect" class="px-3 py-2 rounded-xl bg-emerald-500 hover:bg-emerald-400 text-sm font-medium">Connect</button>
          <button id="btnDisconnect" class="px-3 py-2 rounded-xl bg-rose-500/90 hover:bg-rose-500 text-sm">Detach</button>
        </div>
      </div>

      <div class="grid sm:grid-cols-3 gap-3 pt-2">
        <button id="btnTorchOn" class="rounded-xl bg-emerald-600/90 hover:bg-emerald-600 px-3 py-2 text-sm font-semibold">ğŸ’¡ Torch ON</button>
        <button id="btnTorchOff" class="rounded-xl bg-rose-600/90 hover:bg-rose-600 px-3 py-2 text-sm font-semibold">âŒ Torch OFF</button>
        <button id="btnTakePhoto" class="rounded-xl bg-amber-500/90 hover:bg-amber-500 px-3 py-2 text-sm font-semibold">ğŸ“· Take Photo</button>
      </div>

      <div class="grid sm:grid-cols-3 gap-3 pt-2">
        <button id="btnWriteTest" class="rounded-xl bg-sky-600/90 hover:bg-sky-600 px-3 py-2 text-sm font-semibold">ğŸ§ª Write Test Battery=77</button>
        <button id="btnReadNow" class="rounded-xl bg-indigo-600/90 hover:bg-indigo-600 px-3 py-2 text-sm font-semibold">ğŸ”„ Read Now</button>
        <button id="btnClearLogs" class="rounded-xl bg-slate-700/90 hover:bg-slate-700 px-3 py-2 text-sm font-semibold">ğŸ§¹ Clear Camera URL</button>
      </div>
    </section>

    <!-- Live Values -->
    <section class="glass ring rounded-2xl p-4 grid sm:grid-cols-3 gap-3">
      <div>
        <div class="text-xs text-slate-300">Battery</div>
        <div id="statBattery" class="text-4xl font-extrabold tracking-tight">--%</div>
        <div id="lastUpdate" class="text-xs text-slate-400 mt-1">â€”</div>
      </div>
      <div>
        <div class="text-xs text-slate-300">Status</div>
        <div id="statStatus" class="text-4xl font-extrabold tracking-tight">â€”</div>
      </div>
      <div>
        <div class="text-xs text-slate-300">Camera URL</div>
        <div class="text-xs break-all" id="camUrl">â€”</div>
      </div>
    </section>

    <!-- Logs / Debug Console -->
    <section class="glass ring rounded-2xl p-4">
      <div class="flex items-center justify-between mb-2">
        <h2 class="text-base font-semibold">Debug Console</h2>
        <button id="btnClearConsole" class="text-xs bg-slate-700 hover:bg-slate-600 rounded-lg px-2 py-1">Clear</button>
      </div>
      <pre id="console" class="bg-slate-900/70 rounded-xl p-3 text-xs overflow-auto max-h-72"></pre>
    </section>
  </div>

  <script>
    // ======= State =======
    let app = null; let db = null; let base = null;
    let refBattery = null, refStatus = null, refCam = null;

    // ======= UI helpers =======
    const $ = (id)=>document.getElementById(id);
    function log(...args){ const c = $("console"); c.textContent += args.join(' ') + "\n"; c.scrollTop = c.scrollHeight; }
    function toast(txt){ log('> ', txt); }
    function setLive(on){ $("live").innerHTML = on? '<span class="w-2.5 h-2.5 rounded-full bg-emerald-400 animate-pulse"></span> Live' : '<span class="w-2.5 h-2.5 rounded-full bg-red-400 animate-pulse"></span> Disconnected'; }

    // ======= Firebase init / kill =======
    function init(){
      try{ if(firebase.apps?.length){ firebase.apps.forEach(a=>a.delete?.()); } }catch(e){ log('ignore delete error', e?.message); }
      const cfg = {
        apiKey: $("cfgApiKey").value.trim(),
        authDomain: $("cfgAuthDomain").value.trim(),
        databaseURL: $("cfgDbUrl").value.trim(),
        projectId: $("cfgProjectId").value.trim(),
        storageBucket: $("cfgBucket").value.trim(),
        messagingSenderId: $("cfgSender").value.trim(),
        appId: $("cfgAppId").value.trim(),
      };
      log('Init with', JSON.stringify(cfg));
      app = firebase.initializeApp(cfg);
      db = firebase.database();
      toast('Firebase initialized');
    }

    function kill(){ try{ if(firebase.apps?.length){ firebase.apps.forEach(a=>a.delete?.()); } }catch{} app=null; db=null; setLive(false); toast('Disconnected'); }

    // ======= Attach / Detach listeners =======
    function attach(){
      if(!db){ toast('Init first'); return; }
      base = $("childPath").value.trim();
      if(!base){ toast('Set child path'); return; }
      detach();
      setLive(true);
      // Battery
      refBattery = db.ref(`${base}/Battery`);
      refBattery.on('value', s=>{ const v=s.val(); $("statBattery").textContent=(v!=null?v:'--')+"%"; $("lastUpdate").textContent='Updated '+new Date().toLocaleTimeString(); log('Battery =>', v); });
      // Status
      refStatus = db.ref(`${base}/Status`);
      refStatus.on('value', s=>{ const v=s.val(); $("statStatus").textContent=v||'â€”'; log('Status =>', v); });
      // Camera
      refCam = db.ref(`${base}/camera_result`);
      refCam.on('value', s=>{ const v=s.val(); $("camUrl").textContent=v||'â€”'; log('Camera URL =>', v); });
      toast('Attached to '+base);
    }

    function detach(){ if(refBattery) refBattery.off(); if(refStatus) refStatus.off(); if(refCam) refCam.off(); $("statBattery").textContent='--%'; $("statStatus").textContent='â€”'; $("camUrl").textContent='â€”'; }

    // ======= Commands & Tests =======
    function write(path, obj){ if(!db){ toast('Init first'); return; } db.ref(path).update(obj).then(()=>toast('Wrote '+path)).catch(e=>toast('ERR '+e.message)); }

    $("btnWriteTest").onclick = ()=>{ const p=$("childPath").value.trim(); if(!p) return toast('Set child path'); write(`${p}`, { Battery: 77, Status: 'online' }); };
    $("btnReadNow").onclick   = ()=>{ const p=$("childPath").value.trim(); if(!p) return toast('Set child path'); db.ref(`${p}`).once('value').then(s=>{ log('READ NOW =>', JSON.stringify(s.val(),null,2)); }); };
    $("btnClearLogs").onclick  = ()=>{ const p=$("childPath").value.trim(); if(!p) return toast('Set child path'); db.ref(`${p}/camera_result`).set(null); };

    $("btnTorchOn").onclick  = ()=>{ const p=$("childPath").value.trim(); write(`${p}/commands`, { torch: true, ts: Date.now() }); };
    $("btnTorchOff").onclick = ()=>{ const p=$("childPath").value.trim(); write(`${p}/commands`, { torch: false, ts: Date.now() }); };
    $("btnTakePhoto").onclick = ()=>{ const p=$("childPath").value.trim(); write(`${p}/commands`, { camera: true, ts: Date.now() }); };

    // ======= Bind =======
    $("btnInit").onclick = init; $("btnKill").onclick = kill;
    $("btnConnect").onclick = attach; $("btnDisconnect").onclick = detach;

    // Auto init on load using default values
    window.addEventListener('load', init);
    $("btnConnect").addEventListener('click', ()=> setTimeout(()=>$("btnReadNow").click(), 400));
    $("btnClearConsole").onclick = ()=>($("console").textContent='');
  </script>
</body>
</html>
